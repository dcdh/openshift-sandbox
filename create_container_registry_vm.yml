---
- name: Create container_registry okd virtual machine
  vars:
    installer_path: "/home/{{ ansible_user_id }}/.okd"
    images_path: "{{ installer_path }}/images"
    fedora_coreos_cloud_image_name: "fedora-coreos-31.20200310.3.0-qemu.x86_64.qcow2"
    vms_path: "{{ installer_path }}/vms"
    ip: "10.0.6.11"
    ssh_public_key: "/home/{{ ansible_user_id }}/.ssh/id_rsa.pub"
    dns_name: "container-registry.ocp4-cluster-001.sandbox.okd"
    domain_crt: "{{ installer_path }}/domain.crt"
    domain_key: "{{ installer_path }}/domain.key"
  block:
    - name: Get vms defined
      virt:
        command: info
        uri: "qemu:///session"
      register: info
    - name: Create container_registry virtual machine
      block:
        - name: Create {{ vm_name }} virtual machine directories
          file:
            path: "{{ vms_path }}/container_registry"
            state: directory
            owner: "{{ ansible_user_id }}"
            group: "{{ ansible_user_id }}"
        - name: Copy fedora coreos cloud image from images to {{ vm_name }} virtual machine directory
          copy:
            src: "{{ images_path }}/{{ fedora_coreos_cloud_image_name }}"
            dest: "{{ vms_path }}/container_registry/{{ fedora_coreos_cloud_image_name }}"
            owner: "{{ ansible_user_id }}"
            group: "{{ ansible_user_id }}"
            force: no
        - name: Resize image to add 25G more space. At least 7Go needed for /sysroot
          shell: qemu-img resize {{ vms_path }}/container_registry/{{ fedora_coreos_cloud_image_name }} 25G
        - name: |
            Create container_registry ignition file.
            We will not used the last version 2 of docker registry to avoid this bug: https://github.com/docker/distribution-library-image/issues/89
            Instead we fix it to version 2.6
          block:
            - name: |
                Setup container_registry security
                https://www.openshift.com/blog/openshift-4-2-disconnected-install
                I do not use the htpasswd authentication as I do not need it yet
              block:
                - name: Generate certificats
                  shell: openssl req -newkey rsa:4096 -nodes -sha256 -subj "/C=FR/ST=Paris/L=Paris/O=Organisation/CN={{ dns_name }}" -keyout {{ installer_path }}/domain.key -x509 -days 36500 -out {{ installer_path }}/domain.crt
            - name: Define container_registry fcc file
              copy:
                dest: /tmp/container_registry.fcc
                content: |
                  variant: fcos
                  version: 1.0.0
                  passwd:
                    users:
                      - name: core
                        ssh_authorized_keys:
                          - "{{ lookup('file', ssh_public_key) }}"
                      - name: {{ ansible_user_id }}
                        ssh_authorized_keys:
                          - "{{ lookup('file', ssh_public_key) }}"
                        groups: [ sudo, docker ]
                  storage:
                    files:
                      - path: /opt/certs/domain.crt
                        overwrite: true
                        contents:
                          inline: |
                            {{ lookup('file', domain_crt) | indent(width=10, indentfirst=False) }}
                        mode: 0644
                      - path: /opt/certs/domain.key
                        overwrite: true
                        contents:
                          inline: |
                            {{ lookup('file', domain_key) | indent(width=10, indentfirst=False) }}
                        mode: 0644
                      - path: /etc/containers/registries.conf
                        overwrite: true
                        contents:
                          inline: |
                            [registries.search]
                            registries = ['docker.io', 'registry.fedoraproject.org', 'registry.access.redhat.com', 'registry.centos.org', 'quay.io']

                            [registries.insecure]
                            registries = []

                            [registries.block]
                            registries = []
                  systemd:
                    units:
                      - name: podman-registry.service
                        enabled: true
                        contents: |
                          [Unit]
                          Description=Run podman registry
                          After=network-online.target
                          Wants=network-online.target

                          [Service]
                          TimeoutStartSec=0
                          ExecStartPre=-/usr/bin/mkdir -p /var/lib/registry
                          ExecStartPre=-/bin/podman pull docker.io/library/registry:2.6
                          ExecStart=/bin/podman run --privileged --name registry -p 443:5000 \
                                      -v /var/lib/registry:/var/lib/registry:z \
                                      -v /opt/certs:/certs:z \
                                      -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
                                      -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
                                      --restart=always registry:2.6

                          ExecStop=/bin/podman rm -f registry

                          [Install]
                          WantedBy=multi-user.target
                mode: u=rw,g=r,o=r
                owner: root
                group: root
            - name: Generate container_registry ignition file
              shell: /bin/podman run -i --rm quay.io/coreos/fcct:release --pretty --strict < /tmp/container_registry.fcc > /tmp/container_registry.ign
          become: true
          become_user: root
        - name: Define container_registry virtual machine
          virt:
            command: define
            name: "container_registry"
            xml: '{{ lookup("template", "templates/vm.xml.j2") }}'
            uri: "qemu:///session"
          vars:
            name: "container_registry"
            memory: 8192
            vcpus: 1
            disk_file: "{{ vms_path }}/container_registry/{{ fedora_coreos_cloud_image_name }}"
            vm_mac: "52:54:00:00:06:11"
            vm_bridge: "virbr-okd-int"
            fw_cfg: "name=opt/com.coreos/config,file=/tmp/container_registry.ign"
        - name: Start container_registry vm
          virt:
            command: start
            name: "container_registry"
            autostart: yes
            uri: "qemu:///session"
        - name: Wait for port 22
          wait_for:
            host: "{{ ip }}"
            port: 22
            state: drained
            delay: 10
        - name: |
            Add container_registry host to known_hosts - need to retry as ssh is not available yet after the port 22 is open
            On fedora coreos an empty response can be returned :(
          block:
            - name: Retrieve dns virtual machine public key
              shell: ssh-keyscan -t ssh-rsa {{ ip }}
              register: task_result
              until: task_result.rc == 0 and task_result.stdout != ''
              retries: 120
              delay: 5
            - debug:
                msg: "{{ task_result }}"
            - name: Write dns virtual machine public key into Host known hosts
              lineinfile:
                path: /home/{{ ansible_user_id }}/.ssh/known_hosts
                insertafter: EOF
                line: "{{ dns_name }},{{ task_result.stdout }}"
                backup: yes
      when: info.container_registry is not defined
    - name: Check wildcard *.apps.ocp4-cluster-001.sandbox.okd on container_registry virtual machine resolve to load balander
      block:
        - name: Execute Host resolution
          shell: ssh {{ ansible_user_id }}@{{ ip }} 'dig test.apps.ocp4-cluster-001.sandbox.okd +short'
          register: ip_resolved
        - debug:
            msg: "{{ ip_resolved }}"
        - name: Ensure ip resolved to dns virtual machine ip
          assert:
            that:
              - "'10.0.5.57' == ip_resolved.stdout"
    - name: Check container-registry.ocp4-cluster-001.sandbox.okd on HOST resolve to container-registry
      block:
        - name: Execute Host resolution
          shell: dig container-registry.ocp4-cluster-001.sandbox.okd +short
          register: ip_resolved
        - debug:
            msg: "{{ ip_resolved }}"
        - name: Ensure ip resolved to container-registry virtual machine ip
          assert:
            that:
              - "'{{ ip }}' == ip_resolved.stdout"
    - name: Check external dns resolution is working in {{ vm_name }} virtual machine
      block:
        - name: Execute Host resolution
          shell: ssh {{ ansible_user_id }}@{{ ip }} 'dig google.fr +short'
          register: ips_resolved
        - debug:
            msg: "{{ ips_resolved }}"
        - name: Ensure external host is resolved
          assert:
            that:
              - "ips_resolved is defined"
              - "ips_resolved.stdout_lines is defined"
              - "ips_resolved.stdout_lines|length > 0"
    - name: Wait container_registry container registry service is active
      shell: ssh {{ ansible_user_id }}@{{ ip }} 'sudo systemctl is-active podman-registry.service'
      register: task_result
      until: task_result.stdout == 'active'
      retries: 120
      delay: 5
    - name: Wait for port 443
      wait_for:
        host: container-registry.ocp4-cluster-001.sandbox.okd
        port: 443
        state: drained
        delay: 2
    - name: Pull images to container registry. It can be long as at least 7Gb of data should be downloaded
      shell: ssh {{ ansible_user_id }}@{{ ip }} 'skopeo copy docker://{{ item.imageId }} docker://container-registry.ocp4-cluster-001.sandbox.okd/{{ item.registryMirrorImage }} --dest-tls-verify=false'
      register: task_result
      until: task_result.rc == 0
      retries: 10
      delay: 1
      loop:
        - {name: 'aws-machine-controllers'                        , imageId: 'quay.io/openshift/okd-content@sha256:d7012291e9c5865ace303c2b6c35be3711e73d652ae90d2e5467bed5f41c4c0c', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'azure-machine-controllers'                      , imageId: 'quay.io/openshift/okd-content@sha256:4ce3d483c228aaaf91c14d75173098672c2affc44dccf3e65167cf89dd7b4873', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'baremetal-installer'                            , imageId: 'quay.io/openshift/okd-content@sha256:95be34f25990ad9178a61ae877738637a88904a68a9f11c4db17359b50c4979d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'baremetal-machine-controllers'                  , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'baremetal-operator'                             , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'baremetal-runtimecfg'                           , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'branding'                                       , imageId: 'quay.io/openshift/okd-content@sha256:d112c2c077ad6d1c80f16a93226adbb9d88a8c26d8b0ddac4ca699d11e24f647', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cli'                                            , imageId: 'quay.io/openshift/okd-content@sha256:4cf580957149a349f81593904814aa30eee61ef136c522a799c700a372a200bc', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cli-artifacts'                                  , imageId: 'quay.io/openshift/okd-content@sha256:07c790f6880d5920b314fa7d3ebda19b5609bc6cc4f07b8815a3e93811cf666a', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cloud-credential-operator'                      , imageId: 'quay.io/openshift/okd-content@sha256:f9b899a9793943cc6a9b1949b30b5d2ec6e6df51d2f278c0a86bae1ce8c5e47c', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-authentication-operator'                , imageId: 'quay.io/openshift/okd-content@sha256:59dd2c5dfa4e550aee2ae5a597ec1eebf1c1b7321f6aad1e37cdc88b764e3e5e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-autoscaler'                             , imageId: 'quay.io/openshift/okd-content@sha256:9b1be455318f8821d0ddf51c8ad52213b754161dd4662faa805c996d8370f750', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-autoscaler-operator'                    , imageId: 'quay.io/openshift/okd-content@sha256:ca62e23fd96dedbbe1de969b0c49d7c70922f8fc2f1703a5fff20132775359ea', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-bootstrap'                              , imageId: 'quay.io/openshift/okd-content@sha256:e4fca6e7d9d2df952886ad9d8296a04713996fa42355addb675f52dbd522b421', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-config-operator'                        , imageId: 'quay.io/openshift/okd-content@sha256:84fae4a8848bcdba5e580d683b75e05aeef56e4f594abf77e89b291b23e6553d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-csi-snapshot-controller-operator'       , imageId: 'quay.io/openshift/okd-content@sha256:2b6806349aae50fa83c84d8b408cab9dc300ab59299f012969230f11a9b4e44f', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-dns-operator'                           , imageId: 'quay.io/openshift/okd-content@sha256:d22e725c1fd6de5d42b6e4df41aa2f7ebbbd62d132e99871e8eb83d984be162e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-image-registry-operator'                , imageId: 'quay.io/openshift/okd-content@sha256:03a5df5974ce8e37405529dfc335ffe060cf97b12125b14f4b2841710c7667e4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-ingress-operator'                       , imageId: 'quay.io/openshift/okd-content@sha256:1fde45ec7cc457c0e4d0a1c1abc297c9a861fb837f9a95c582c7c7c5c7522875', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-kube-apiserver-operator'                , imageId: 'quay.io/openshift/okd-content@sha256:b37c3adf7dabbdee9ef3ea7e09c2479d278dd5da8460988b2f28fa1d59d38ff7', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-kube-controller-manager-operator'       , imageId: 'quay.io/openshift/okd-content@sha256:b1bc436866baf7122e0c9dc019bd6cc4265fd67b586b2ad551ab2132a66449dc', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-kube-scheduler-operator'                , imageId: 'quay.io/openshift/okd-content@sha256:c26d9f90dfd98039adb0f8f60f8f878a9d76abc9d2be4085db5808edce60269a', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-kube-storage-version-migrator-operator' , imageId: 'quay.io/openshift/okd-content@sha256:b3744b5f356b6fa530be73237866e6d2c2a0b817e4bc1a8fec5902cf5bf2e0f0', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-machine-approver'                       , imageId: 'quay.io/openshift/okd-content@sha256:18ab18e9107e66344ed439c796d33f0ea193fb3aba86b3783a85186d1300bd02', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-monitoring-operator'                    , imageId: 'quay.io/openshift/okd-content@sha256:defedba73ff6f738acee8f7b0bba7ab9960e19d1ecd49b81ef1170716bc968e3', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-network-operator'                       , imageId: 'quay.io/openshift/okd-content@sha256:5ffd6ac07bbcdeacf250cd45b7baa62feb5ef179f61c27f2b1f4abc7ba4646d9', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-node-tuned'                             , imageId: 'quay.io/openshift/okd-content@sha256:1e23f784aafacbb7b7671b9b9e7af72efbc6bdbae42c0d8ac33f5658f51b070c', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-node-tuning-operator'                   , imageId: 'quay.io/openshift/okd-content@sha256:1cf6a1f0fab933ad6687944f3574d75c46f98416e27f4a683aa7d9849273cd71', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-openshift-apiserver-operator'           , imageId: 'quay.io/openshift/okd-content@sha256:9b17a806a162bfdaad117414f841f754b18239a3d3d1f7e8f1fae476d616ed04', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-openshift-controller-manager-operator'  , imageId: 'quay.io/openshift/okd-content@sha256:6fb78c388d0ece9ae82fc4dabca100ea9168a4fd25b3460293a568f08f140241', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-policy-controller'                      , imageId: 'quay.io/openshift/okd-content@sha256:2318c5f5872119e349d770145467f4330863850a16c1374db0611253fdc28cdb', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-samples-operator'                       , imageId: 'quay.io/openshift/okd-content@sha256:a514aaa249ae8d9254dbddd4e39731321d08fed15159692cf8413743ee580ee2', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-storage-operator'                       , imageId: 'quay.io/openshift/okd-content@sha256:840a96981e7c271f099fef1ae64ba89473b3fa36fd5407e4900c1b1e494d10ee', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-svcat-apiserver-operator'               , imageId: 'quay.io/openshift/okd-content@sha256:d2b340d51b7e02111b4fee1569975ff5ec8d6d8770ac0671ba8fed167116282f', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-svcat-controller-manager-operator'      , imageId: 'quay.io/openshift/okd-content@sha256:96f621e58fe3148f4d01dbd82e1d5f65e12ff3530013cbc87b0d42a184692d26', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-update-keys'                            , imageId: 'quay.io/openshift/okd-content@sha256:b8492bf0aaa85c45ab08399a4f7940abd1a91e3529101a7c6d09552675c13e9a', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'cluster-version-operator'                       , imageId: 'quay.io/openshift/okd-content@sha256:3c79acb0159eb1bdb1401afdc7f1e25bd3bf56845661a05fafad8f912905746a', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'configmap-reloader'                             , imageId: 'quay.io/openshift/okd-content@sha256:5a80db4af2259ef884bfbcabb14d4938cd6c20a7fbad141b914400ef33cf8523', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'console'                                        , imageId: 'quay.io/openshift/okd-content@sha256:747be724483a632b55ce6aaaabc70bb3d45db4d30f5f3675ac21eb9823c5aae3', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'console-operator'                               , imageId: 'quay.io/openshift/okd-content@sha256:293446b1ca734c6547753604d857fabf2e2fcd01b8994b05af88a7239e7c1c05', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'container-networking-plugins'                   , imageId: 'quay.io/openshift/okd-content@sha256:0bf6503fa80d9ce976a995dcf9b2b01927b919ae47111e36d063d28af6276974', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'coredns'                                        , imageId: 'quay.io/openshift/okd-content@sha256:74fddfb70ad0ca74b3e6814ea0d11df70a457afd1ae48a18322f34ffb605914d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'csi-snapshot-controller'                        , imageId: 'quay.io/openshift/okd-content@sha256:27cf2098b7dbb563536c5d59752b117c99baa5a97bb30be7a585874863c13d6a', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'deployer'                                       , imageId: 'quay.io/openshift/okd-content@sha256:10c8be7261d8e604a8a433015a43e6fa9bb37d2d56fdce04c16be6925ff6e366', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'docker-builder'                                 , imageId: 'quay.io/openshift/okd-content@sha256:70d0fd53fd56975f5502e798ae26286c5ad10731ff85ae4c489e52951ceea3e8', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'docker-registry'                                , imageId: 'quay.io/openshift/okd-content@sha256:712750fdb0aa61a3dcf9498ed64cc079e695d021bea3a5c0f2bb821cfb8194c9', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'etcd'                                           , imageId: 'quay.io/openshift/okd-content@sha256:f0fa1e9c84c55121634eeb5dd992dd0958835d330515c4d0fb0508e92ef3011e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'gcp-machine-controllers'                        , imageId: 'quay.io/openshift/okd-content@sha256:eb54708e2b58404cf6643dc48b3778caa67d713409774014601b34d78821aefc', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'grafana'                                        , imageId: 'quay.io/openshift/okd-content@sha256:9cbe5048f0dd799171320ba7e1e83f3cddf2956282a7665e448768eaffd21ecf', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'haproxy-router'                                 , imageId: 'quay.io/openshift/okd-content@sha256:c5aa779b80bf6b7f9e98a4f85a3fec5a17543ce89376fc13e924deedcd7298cf', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'hyperkube'                                      , imageId: 'quay.io/openshift/okd-content@sha256:947052b5679076b0d85dd712910a15aa3d733e2b975cb56a2cff2eda4514f44d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'insights-operator'                              , imageId: 'quay.io/openshift/okd-content@sha256:f87a69df94f83b5067ff626a27e5697048159442148ad5abf52e8ac7894e2fc0', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'installer'                                      , imageId: 'quay.io/openshift/okd-content@sha256:61e7ffba8f1265909c21f177ff449e19b23b1966a0aae467b676835834c52d1e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'installer-artifacts'                            , imageId: 'quay.io/openshift/okd-content@sha256:4a181c521b4f016ef4f38a3c1303ca8de4a329e75ded6fb9ae69d35143154fdf', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ironic'                                         , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ironic-hardware-inventory-recorder'             , imageId: 'quay.io/openshift/okd-content@sha256:ce3aacf5a6eb3e8697d8415d4a4ec39093c06def983bb2e75a552b604cee6376', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ironic-inspector'                               , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ironic-ipa-downloader'                          , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ironic-machine-os-downloader'                   , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ironic-static-ip-manager'                       , imageId: 'quay.io/openshift/okd-content@sha256:227fd1bb9185e667de520c3428e07c2a3b19f47a30f3770a06611d4d9d1901a4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'jenkins'                                        , imageId: 'quay.io/openshift/okd-content@sha256:da2ca127297777cd383847be42b70db7c998f8fc234153d07c87c89637aa164f', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'jenkins-agent-maven'                            , imageId: 'quay.io/openshift/okd-content@sha256:5a7f9708f6c2dca71642d24b37d50c9f609c375d1a1360a91dd7ad774281c09d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'jenkins-agent-nodejs'                           , imageId: 'quay.io/openshift/okd-content@sha256:df5d336b302a35d394ac3db1652a8c795bb7c3894962a374d5d664e89123bed4', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'k8s-prometheus-adapter'                         , imageId: 'quay.io/openshift/okd-content@sha256:12bac47c71cb7ef36b6ee7b78e0476fbfb8a67bbf61ac42c461c17c98ac850a6', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'keepalived-ipfailover'                          , imageId: 'quay.io/openshift/okd-content@sha256:f66d8e479f12e62b847f61520959dcac6626a98a3617157bb70974ea6544df79', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kube-client-agent'                              , imageId: 'quay.io/openshift/okd-content@sha256:c51f96d98e427bcfcca558c9a5e2376fe198848d557d00653626d6dc7012691e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kube-etcd-signer-server'                        , imageId: 'quay.io/openshift/okd-content@sha256:001db6ee754695c5ef85966747e7a98fff4d80589f16db93d285c5189220cedb', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kube-proxy'                                     , imageId: 'quay.io/openshift/okd-content@sha256:d868bfe9d6bb78543b1161f3e856721b7bc8d32486c4051f3154836f911a58fc', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kube-rbac-proxy'                                , imageId: 'quay.io/openshift/okd-content@sha256:4da76173cdd5d8699be46fcaba2c5911f83e9f2dc33b2c47768fda2df5415f1c', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kube-state-metrics'                             , imageId: 'quay.io/openshift/okd-content@sha256:32b1681cfdafb380245761890a8944e26fb4ae84556ed632497a798638eb6223', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kube-storage-version-migrator'                  , imageId: 'quay.io/openshift/okd-content@sha256:154e22e58ac70907207106b431629cf43f7f771b230df438143e18f6a6781a58', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kuryr-cni'                                      , imageId: 'quay.io/openshift/okd-content@sha256:e20bea444a8cb1521706ad09f0f7af000b88195131c2cc83ad5cc7cb46e736b0', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'kuryr-controller'                               , imageId: 'quay.io/openshift/okd-content@sha256:ebf6388df3463fb840a97dc8fe3e7d719065add139a5b51fc1c8d998c44b3027', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'libvirt-machine-controllers'                    , imageId: 'quay.io/openshift/okd-content@sha256:b9d78a6300ae7d414aa2e4cb3353416d1c12c28ca2fb4b8874ad23c2937e4ccc', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'local-storage-static-provisioner'               , imageId: 'quay.io/openshift/okd-content@sha256:873e4138f9c01976cc6c95a9390d47b0ab235e743f00ae2f1fa95835af6f8663', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'machine-api-operator'                           , imageId: 'quay.io/openshift/okd-content@sha256:3bf647014d678478f60599503d6b1672f9e989be8321b968f4bf5adde97ca319', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'machine-config-operator'                        , imageId: 'quay.io/openshift/okd-content@sha256:eb80e4bff3178a5cccca2c8538a0361b7c547d754fa2c820b487fd969dbd064d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'machine-os-content'                             , imageId: 'quay.io/openshift/okd-content@sha256:6ac2b567d210bbeb8987f5902cf2d4c0c2cd6dfedc58356237df4fecaddb6f50', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'mdns-publisher'                                 , imageId: 'quay.io/openshift/okd-content@sha256:05796e1957def783c8f6b368ec40d524d1b1bb065a3fbfa4ecc3e51a85be5e4d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'multus-admission-controller'                    , imageId: 'quay.io/openshift/okd-content@sha256:48fb3fae513be94f37d068506a2fb3553de055bd957524c3d5cd06c3ab63dc71', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'multus-cni'                                     , imageId: 'quay.io/openshift/okd-content@sha256:610f461e926dafbaca4a447f730b956f67ec850b06594299c780596b81a789ac', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'must-gather'                                    , imageId: 'quay.io/openshift/okd-content@sha256:dd03a9e0ac7b6e710037d8f0d0a5001b47c27bf859e49b0256e8ac54f5bd8198', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'oauth-apiserver'                                , imageId: 'quay.io/openshift/okd-content@sha256:444be72589abd150e048f5008c819c3c4527bf4197bb93bbdeb2f012e80e495c', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'oauth-proxy'                                    , imageId: 'quay.io/openshift/okd-content@sha256:9bc48eb62fe6cc492ffdd28d874dbe7d0ebe9d24a53e230864644393fdb759b9', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'oauth-server'                                   , imageId: 'quay.io/openshift/okd-content@sha256:c4b3533cd2490d00af1097bfa271653bba0a45085df703c60c415a16cb2dbe0d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'openshift-apiserver'                            , imageId: 'quay.io/openshift/okd-content@sha256:e79206d7d4d54c97bf1eb2da8af2cf7b147d11d6b0f7627034d0bb80d81bf60e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'openshift-controller-manager'                   , imageId: 'quay.io/openshift/okd-content@sha256:76bdd6a87bcb60c7fafca4bdcf931e5968cabcab7e9ea4ac36130971002440d5', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'openshift-state-metrics'                        , imageId: 'quay.io/openshift/okd-content@sha256:cab7b3add9e14e41c137081b1eb3ac0fc43b4df7682fff1442d8f7fbf2415477', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'openstack-machine-controllers'                  , imageId: 'quay.io/openshift/okd-content@sha256:dfc03f38bc29c6f6e0235a7c9524de904c31b1fd9105ad0e89bc40f8d07f15d6', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'operator-lifecycle-manager'                     , imageId: 'quay.io/openshift/okd-content@sha256:93144da1183a81ea07f172304ba515ce079bddb8c3170c851d497b912a7e271e', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'operator-marketplace'                           , imageId: 'quay.io/openshift/okd-content@sha256:917586c0ca3e3ffbb8a0073295dbbcdf8cdd6f43089c30dad8826bcb77f8d3dc', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'operator-registry'                              , imageId: 'quay.io/openshift/okd-content@sha256:efb890b4220237cb17627432c3c41aa6b3380afa6c9fce33282787db9adf4376', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ovirt-machine-controllers'                      , imageId: 'quay.io/openshift/okd-content@sha256:cc6c2bbc30d94615e4e514e1281ddbb266378bd9e7b252d39ba952e32d6caece', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'ovn-kubernetes'                                 , imageId: 'quay.io/openshift/okd-content@sha256:7499e1a0060f11ebcf330f5836c928afc838848825b6db1668f1072c8d8d884b', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'pod'                                            , imageId: 'quay.io/openshift/okd-content@sha256:2f68508143d397e98e2aa53967d28357263a10d0832d611bee1656b3a32ecbc2', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'prom-label-proxy'                               , imageId: 'quay.io/openshift/okd-content@sha256:8d83284334b9e4d5b25b380ff6b29c27caa1a0234cff00e8eddb32b45f25b63b', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'prometheus'                                     , imageId: 'quay.io/openshift/okd-content@sha256:5af0373659974782379d90d9a174352dd8f85cb7327cc48ef36cae4e8ba5903f', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'prometheus-alertmanager'                        , imageId: 'quay.io/openshift/okd-content@sha256:25bed531ccb0ff16ce19b927265f03cb9b2d572caa224ef302002269e925d83c', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'prometheus-config-reloader'                     , imageId: 'quay.io/openshift/okd-content@sha256:8834b335cd978c4e610120441f3e1dac096c14c338b1507e1d0f7441ed15dcc1', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'prometheus-node-exporter'                       , imageId: 'quay.io/openshift/okd-content@sha256:3f860d6b51ea4f8b3670764679ac976dcef8344c53a278e52b6f224e3b69f937', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'prometheus-operator'                            , imageId: 'quay.io/openshift/okd-content@sha256:99776dd55bf71dc46b6aea5aa9a86c3c3979875f323158eed6b24d0ebddfe209', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'sdn'                                            , imageId: 'quay.io/openshift/okd-content@sha256:0bc62f9245a3e0677cf6df3ba9065dd8f1a31b6f6a6b4dd69cdc03b7d87a2829', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'service-ca-operator'                            , imageId: 'quay.io/openshift/okd-content@sha256:57f34d90a75139702e85ed251d2d8f6f989910c02e1ecefa00964f74afbef61d', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'service-catalog'                                , imageId: 'quay.io/openshift/okd-content@sha256:24121dc11c9d253da0b1cf337b6d5ceeaa8ccd25bb3d7dd7341480360bb87551', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'support-operator'                               , imageId: 'quay.io/openshift/okd-content@sha256:3d90fb1948a406f15f5b960d2e3d5b9469ee0b0d8273a3341f4c548bdabfcae3', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'telemeter'                                      , imageId: 'quay.io/openshift/okd-content@sha256:1a4259253638a53b9a82813b61e18c3c851cc906c80f5a8ee70599298d63ca17', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'tests'                                          , imageId: 'quay.io/openshift/okd-content@sha256:22d543b028452b97ebedf7fa18c4f2fb5004bd0d0daa20da8de5e7533e24b9b2', registryMirrorImage: 'openshift/okd-content'}
        - {name: 'thanos'                                         , imageId: 'quay.io/openshift/okd-content@sha256:156ee3923fa70e7bd3b7a173f0e7dc7d9fd50dcc0216b1fefc9ed324f34b07f8', registryMirrorImage: 'openshift/okd-content'}
    - name: Check repository "openshift/okd-content" exists
      block:
        - name: Get list of repositories
# TODO faire le test depuis bootstrap
          shell: curl -k https://container-registry.ocp4-cluster-001.sandbox.okd:443/v2/_catalog
          register: repositories
        - debug:
            msg: "{{ repositories }}"
        - name: Ensure repositories contains "openshift/okd-content"
          assert:
            that:
              - "'openshift/okd-content' in (repositories.stdout | from_json).repositories"